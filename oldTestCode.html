<script>

    document.getElementById('metamaskButton').addEventListener('click', event => {
            let accountAddress;
            let button = event.target;

            window.ethereum.request({method: 'eth_requestAccounts'}).then(accounts => {
            let accountAddress = accounts[0];
            console.log(accountAddress)
            button.textContent = accountAddress;
            })
    });

    async function connectWeb3() {
        if (window.ethereum.request({ method: 'eth_accounts' })) {
            web3.eth.accounts = new Web3(ethereum.request({ method: 'eth_accounts'}));
            window.ethereum.request({method: 'eth_accounts' }).enable();
        }
    }

    async function load() {
        await connectWeb3();
        window.contract = await loadContract();
        updateStatus('Ready!');
    }

    function updateStatus(status) {
        const web3Logged = document.getElementById('metamaskButton');
        web3Logged.innerHTML = status;
        console.log(status);
    }

    // get a new copy instance of our abi json structure and contract address
    async function loadContract() {
        const web3 = new Web3(window.ethereum);
        return await new web3.eth.Contract([
        {
        "inputs": [
            {
            "internalType": "string",
            "name": "name",
            "type": "string"
            },
            {
            "internalType": "string",
            "name": "symbol",
            "type": "string"
            },
            {
            "internalType": "uint256",
            "name": "maxSupply",
            "type": "uint256"
            }
        ],
        "name": "newToken",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
        },
        {
        "inputs": [
            {
            "internalType": "address",
            "name": "",
            "type": "address"
            },
            {
            "internalType": "uint256",
            "name": "",
            "type": "uint256"
            }
        ],
        "name": "tokens",
        "outputs": [
            {
            "internalType": "address",
            "name": "",
            "type": "address"
            }
        ],
        "stateMutability": "view",
        "type": "function"
        }
    ],
    '0xBD8D5Acba4f00ffeA7EC84b830028fB4d5a18060'
    );
}
async function getCurrentAccount() {
    let accountAddress;
            let metaMaskBtn = document.getElementById('metamaskButton');
            window.ethereum.request({method: 'eth_requestAccounts'}).then(accounts => {
            let accountAddress = accounts[0];
            console.log(accountAddress)
            metaMaskBtn.textContent = accountAddress;
})}

// async function sendNewTokenInfo() {
// 	const account = await getCurrentAccount();
// 	const newTokenInfo = await contract.methods.newToken({type,name,symbol,maxSupply}).send({ from: account });
// }

    //grab the data from the form
    document.getElementById("tokenForm").addEventListener("submit", async function(event) {
     event.preventDefault();
     const formData = new FormData(event.target);
     const tokenType = formData.get("tokenType");
     const tokenName = formData.get("tokenName");
     const tokenSymbol = formData.get("tokenSymbol");
     const maxSupply = formData.get("maxSupply");

     const requestData = {
         tokenType,
         name: tokenName,
         symbol: tokenSymbol,
         maxSupply: parseInt(maxSupply),
     };
     //console.log()
     let type = requestData.tokenType;
     let name = requestData.tokenName;
     let symbol = requestData.symbol;
     let maxSupplyy = requestData.maxSupply;
        const accounts =  getCurrentAccount();
        const account = accounts[0];
        const contract = await loadContract();
        console.log(contract);
        const newTokenInfo = contract.methods.newToken(name, symbol, maxSupply).send({
            from: account,
            gasPrice: '200000'
        });
    })

    async function load() {
    await loadWeb3();
    updateStatus('Ready!');
    window.contract = await loadContract();
    
}

//      .then(data => {
//          // Handle the success response from the backend
//          document.getElementById("successMessage").style.display = "block";
//          document.getElementById("successMessage").textContent = "Token created successfully!";
//          document.getElementById("errorMessage").style.display = "none";
//      })
//      .catch(error => {
//          // Handle errors and display an error message to the user
//          document.getElementById("successMessage").style.display = "none";
//          document.getElementById("errorMessage").style.display = "block";
//          document.getElementById("errorMessage").textContent = "Error: " + error.message;
//          console.error(error);
//      });
//  });

    </script>